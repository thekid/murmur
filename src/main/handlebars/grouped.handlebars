{{#> layout}}
  {{#*inline "title"}}Feed{{/inline}}
  {{#*inline "content"}}
    <h1>Grouped Feed</h1>

    <!-- Groups -->
    <div class="ui vertical segment">
      <div class="ui labels">
        {{#each groups}}
          <a class="ui image label" style="margin: .3em" data-id="{{id}}" onclick="toggle(this)">
            <img src="{{mugshot_url}}">
            {{full_name}}
            <div class="detail">{{stats.members}}</div>
          </a>
        {{/each}}
      </div>
    </div>

    <!-- Feed generated by these groups -->
    <div class="ui vertical segment">
      {{{{template}}}}
        <template id="event">
          <div class="card">
            <div class="content">
              <div class="header">New post in <a href="{{group.web_url}}">{{group.full_name}}</a></div>
              <div class="meta">
                <span class="date"><a title="{{message.id}}" class="date" href="{{message.web_url}}">{{format.date(message.created_at)}}</a></span>
              </div>
              <div class="description">
                <p class="excerpt" data-content="{{message.content_excerpt}}" data-variation="wide inverted">{{format.first(message.content_excerpt)}}</p>
              </div>
            </div>
            <div class="extra content">
              <div class="center aligned author">
                <img class="ui avatar image" src="{{sender.mugshot_url}}"> <a href="{{sender.web_url}}">{{sender.full_name}}</a>
              </div>
            </div>
          </div>
        </template>
      {{{{/template}}}}

      <div class="ui cards" id="feed">
        Select one or more groups
      </div>

      <div class="ui dimmer" id="loading">
        <div class="ui loader"></div>
      </div>
    </div>
  {{/inline}}
  {{#*inline "script"}}
    <script type="text/javascript">
      const results = {};
      const selected = {};
      let debounce = null;

      function toggle($el) {
        clearTimeout(debounce);
        let id = $el.dataset.id;
        if (typeof(selected[id]) === 'undefined') {
          $el.classList.add('violet');
          selected[id] = true;
        } else {
          $el.classList.remove('violet');
          delete selected[id];
        }
        debounce = setTimeout(update, 1000);
      }

      function update() {
        const $feed = document.getElementById('feed');
        const $loading = document.getElementById('loading');
        const template = document.getElementById('event').innerHTML;

        let todo = Object.keys(selected).length;
        if (0 === todo) {
          $feed.innerHTML = '';
          return ;
        }

        $loading.classList.add('active');
        let completed = () => {
          todo--;
          if (todo > 0) return;

          let references = [];
          let messages = [];
          for (const id in selected) {
            if (typeof(results[id]) === 'undefined') {
              console.log('Missing result', id);
              continue;
            }

            for (const reference of results[id].references) {
              if (typeof(references[reference.type]) === 'undefined') {
                references[reference.type] = {};
              }
              references[reference.type][reference.id] = reference;
            }
            messages = messages.concat(results[id].messages);
          }

          messages.sort((a, b) => b.id - a.id);

          let html = '';
          for (const message of messages) {
            let sender = references.user[message.sender_id];
            let group = references.group[message.group_id];
            html += template.replaceAll(format.placeholders, (match, placeholder) => format.html(eval(placeholder)));
          }

          $feed.innerHTML = html;
          $loading.classList.remove('active');
          $('.excerpt').popup();
        }
        for (const id in selected) {
          if (typeof(results[id]) === 'undefined') {
            fetch('/api/feed/group/' + id + '?limit=3', {method: 'GET', credentials: 'same-origin'})
              .then(res => res.json())
              .then(result => { results[id] = result; completed(); })
              .catch(error => { results[id] = {references: [], messages: []}; console.error(error); completed(); })
            ;
          } else {
            completed();
          }
        }
      }
    </script>
  {{/inline}}
{{/layout}}