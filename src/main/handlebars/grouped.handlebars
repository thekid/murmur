{{#> layout}}
  {{#*inline "title"}}{{lookup navigation request.uri.path}}{{/inline}}
  {{#*inline "content"}}
    <h1>{{> title}}</h1>
    <div class="ui vertical segment">
      <div class="ui labels">
        {{#each groups}}
          <a class="ui image label is-group" style="margin: .3em" data-id="{{id}}" onclick="toggle(this)">
            <img src="{{mugshot_url}}">
            {{full_name}}
            <div class="detail">{{stats.members}}</div>
          </a>
        {{/each}}
      </div>
    </div>

    <!-- Feed generated by these groups -->
    <div class="ui vertical segment" id="content" style="margin-top: 1em">
      <div class="ui stackable cards" id="feed">
        <div class="card">
          <div class="content">
            <div class="ui placeholder">
              <div class="header"><div class="medium line"></div></div>
              <div class="meta"><div class="short line"></div></div>
            </div>
            <div class="ui placeholder">
              <div class="description"><div class="line"></div></div>
            </div>
          </div>
          <div class="extra content">
            <div class="center aligned author">
              <div class="ui placeholder">
                <div class="avatar image"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  {{/inline}}
  {{#*inline "script"}}
    <script type="text/javascript">
      const results = {};
      const selected = {};
      let debounce = null;

      function toggle($el) {
        clearTimeout(debounce);
        const id = $el.dataset.id;
        if (typeof(selected[id]) === 'undefined') {
          $el.classList.add('violet');
          selected[id] = true;
        } else {
          $el.classList.remove('violet');
          delete selected[id];
        }

        // Update local storage, ignoring exceptions
        try {
          localStorage.setItem('selected', Object.keys(selected).join(','));
        } catch (e) {
          console.log(e);
        }
        debounce = setTimeout(update, 1000);
      }

      function update() {
        const $content = document.getElementById('content');
        const $feed = document.getElementById('feed');
        const template = Handlebars.compile(`{{{source 'templates/messages'}}}`);

        let todo = Object.keys(selected).length;
        if (0 === todo) {
          $feed.innerHTML = '';
          return ;
        }

        $content.classList.add('loading');
        let completed = () => {
          todo--;
          if (todo > 0) return;

          let edges = [];
          let errors = [];
          for (const id in selected) {
            if (undefined === results[id]) {
              errors.push('Missing result for group #' + id);
            } else if (null === results[id].error) {
              edges = edges.concat(results[id].result.group.feed.threads.edges);
            } else {
              errors.push('Error fetching group #' + id + ': ' + results[id].error.message);
            }
          }

          edges.sort((a, b) => ((a.node.updatedAt === b.node.updatedAt) ? 0 : ((a.node.updatedAt > b.node.updatedAt) ? -1 : 1)));

          $feed.innerHTML = template({edges: edges, errors: errors});
          $content.classList.remove('loading');
          $('.excerpt').popup();
        }
        for (const id in selected) {
          if (undefined === results[id] || null !== results[id].error) {
            fetch('/api{{request.uri.path}}/' + id + '?limit=5', {method: 'GET', credentials: 'same-origin'})
              .then(res => res.ok ? res.json() : (function() { throw new Error(res.status + ': ' + res.statusText); })())
              .then(result => { results[id] = {result: result, error: null}; completed(); })
              .catch(error => { results[id] = {result: null, error: error}; completed(); })
            ;
          } else {
            completed();
          }
        }
      }

      window.onload = function() {
        let stored = null;
        try {
          stored = localStorage.getItem('selected');
        } catch (e) {
          console.log(e);
        }

        if (!stored) {
          document.getElementById('feed').innerHTML = 'Select one or more groups';
          return;
        }

        for (const id of stored.split(',')) {
          const $el = document.querySelector('.is-group[data-id="'+id+'"]');
          if ($el) {
            $el.classList.add('violet');
            selected[id] = true;
          } else {
            console.log('Stale group #', id);
          }
        }
        update();
      };
    </script>
  {{/inline}}
{{/layout}}